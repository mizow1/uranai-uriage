# 要件文書

## はじめに

この機能は、LINE Fortuneの日次レポートメールの処理を自動化します。システムはdev-line-fortune@linecorp.comからmizoguchi@outward.jpに送信され、件名に「LineFortune Daily Report」を含むメールを監視します。そのようなメールが検出されると、システムは添付のCSVファイルを抽出し、適切な日付形式でリネームし、特定のフォルダ構造に保存します。さらに、システムは月次フォルダ内のすべてのCSVファイルのデータを含む統合CSVファイルを生成します。

## 要件

### 要件1：メール監視と処理

**ユーザーストーリー:** ユーザーとして、LINE Fortune Daily Reportメールを自動的に処理し、CSVの添付ファイルを手動でダウンロードして整理する必要がないようにしたい。

#### 受け入れ基準

1. dev-line-fortune@linecorp.comからmizoguchi@outward.jpにメールが受信され、かつ件名に「LineFortune Daily Report」が含まれる場合、システムはそのメールを処理するものとする。
2. メールを処理する際、システムはすべてのCSVファイル添付を抽出するものとする。
3. システムがメールの処理に失敗した場合、システムはエラーをログに記録し、他のメールの処理を継続するものとする。
4. 一致するメールにCSV添付ファイルが見つからない場合、システムは警告をログに記録するものとする。

### 要件2：ファイル名付けと整理

**ユーザーストーリー:** ユーザーとして、抽出されたCSVファイルに日付を付けて特定のフォルダ構造に保存し、一貫して整理されるようにしたい。

#### 受け入れ基準

1. CSVファイルが抽出される際、システムはファイル名にyyyy-mm-dd形式の日付を含めるようリネームするものとする。
2. システムがメール件名「LineFortune Daily Report for yyyy-mm-dd」から日付を抽出する際、システムはこの日付をファイル名付けに使用するものとする。
3. CSVファイルを保存する際、システムはパス「C:\Users\OW\Dropbox\disk2とローカルの同期\占い\占い売上\履歴\ISP支払通知書\yyyy\yyyymm\」に保存するものとする。ここでyyyyとyyyymmはメールの日付から導出される。
4. 対象ディレクトリが存在しない場合、システムはそれを作成するものとする。

### 要件3：統合ファイル生成

**ユーザーストーリー:** ユーザーとして、月次フォルダ内のすべてのCSVファイルのデータを含む統合CSVファイルを自動的に生成し、月次データ全体を簡単に分析できるようにしたい。

#### 受け入れ基準

1. 新しいCSVファイルが月次フォルダに保存される際、システムはそのフォルダ内のすべてのCSVファイルのデータを含む統合CSVファイルを生成するものとする。
2. 統合ファイルを生成する際、システムはそれを「line-menu-yyyy-mm.csv」と名付けるものとする。ここでyyyyとmmはフォルダ名から導出される。
3. 統合ファイルがすでに存在する場合、システムは更新版でそれを上書きするものとする。
4. CSVファイルを統合する際、システムはヘッダー行を統合ファイルの先頭に一度だけ維持するものとする。

### 要件4：エラー処理とログ記録

**ユーザーストーリー:** ユーザーとして、システムがエラーを適切に処理し、意味のあるログを提供することで、問題が発生した際にトラブルシューティングできるようにしたい。

#### 受け入れ基準

1. 処理中に何らかのエラーが発生した場合、システムはタイムスタンプ、エラータイプ、コンテキストを含むエラー詳細をログに記録するものとする。
2. システムが対象ディレクトリにアクセスできない場合、システムは失敗する前に最大3回再試行するものとする。
3. システムが特定のCSVファイルの処理に失敗した場合、システムは他のファイルの処理を継続し、エラーをログに記録するものとする。
4. システムがメールの処理を完了した場合、システムは処理されたファイルの詳細を含む成功メッセージをログに記録するものとする。